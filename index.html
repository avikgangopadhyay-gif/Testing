<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Cosmic App</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{background:#020617;color:white;font-family:Arial}
.box{max-width:420px;margin:auto;margin-top:30px;padding:20px;border:1px solid #1e293b;border-radius:10px}
input,button{width:100%;padding:12px;margin-top:10px;border-radius:6px;border:none}
button{background:#3b82f6;color:white;font-size:16px}
img{border-radius:50%;display:block;margin:auto;object-fit:cover}
video{width:100%;margin-top:10px;border-radius:10px}
</style>
</head>

<body>

<div class="box" id="authPage">
  <h2>Signup / Login</h2>
  <input id="name" placeholder="Name">
  <input id="username" placeholder="Username">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="signup()">Sign Up</button>
  <button onclick="login()">Login</button>
  <button onclick="googleLogin()">Google Login</button>
</div>

<div class="box" id="mainPage" style="display:none">
  <h2>My Profile</h2>

  <img id="profileImg" width="120" height="120"
   src="https://via.placeholder.com/120">

  <p id="reelCountText" style="text-align:center"></p>

  <input type="file" id="profileInput" accept="image/*">

  <hr>

  <h3>Upload Reel</h3>
  <input type="file" id="reelInput" accept="video/*">
  <video id="reelPreview" controls></video>

  <h3>My Reels</h3>
  <div id="myReels"></div>

  <button onclick="logout()">Logout</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

import { getFirestore, doc, setDoc, getDoc, addDoc,
collection, query, where, getDocs, updateDoc, increment }
from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

/* ðŸ”¥ Firebase */
const firebaseConfig={
  apiKey:"AIzaSyCaF0U-gGY0r6uUgQ485NDggSPz5rIop7o",
  authDomain:"robos-ca998.firebaseapp.com",
  projectId:"robos-ca998"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

/* â˜ï¸ Cloudinary */
const CLOUD="dvhyjrc1q";
const PRESET_PROFILE="Upload_profile";
const PRESET_REEL="Upload_reels";

/* Elements */
const authPage=document.getElementById("authPage");
const mainPage=document.getElementById("mainPage");
const profileImg=document.getElementById("profileImg");
const reelCountText=document.getElementById("reelCountText");
const myReels=document.getElementById("myReels");

/* AUTH */
window.signup=async()=>{
 const cred=await createUserWithEmailAndPassword(auth,email.value,password.value);
 await setDoc(doc(db,"users",cred.user.uid),{
  name:name.value,username:username.value,email:email.value,
  profileImage:"",reelCount:0
 });
};

window.login=()=>signInWithEmailAndPassword(auth,email.value,password.value);

window.googleLogin=async()=>{
 const res=await signInWithPopup(auth,new GoogleAuthProvider());
 const ref=doc(db,"users",res.user.uid);
 if(!(await getDoc(ref)).exists()){
  await setDoc(ref,{
   name:res.user.displayName,
   email:res.user.email,
   profileImage:res.user.photoURL||"",
   reelCount:0
  });
 }
};

/* LOAD PROFILE SAFE */
async function loadProfile(uid){
 const snap=await getDoc(doc(db,"users",uid));
 const data=snap.exists()?snap.data():{};
 profileImg.src=data.profileImage||"https://via.placeholder.com/120";
 reelCountText.innerText=`ðŸŽ¬ Reels: ${data.reelCount ?? 0}`;
}

/* LOAD ALL REELS */
async function loadReels(uid){
 myReels.innerHTML="";
 const q=query(collection(db,"reels"),where("uid","==",uid));
 const snap=await getDocs(q);
 snap.forEach(d=>{
  const v=document.createElement("video");
  v.src=d.data().reelUrl;
  v.controls=true;
  myReels.appendChild(v);
 });
}

/* AUTH STATE */
onAuthStateChanged(auth,user=>{
 if(user){
  authPage.style.display="none";
  mainPage.style.display="block";
  loadProfile(user.uid);
  loadReels(user.uid);
 }
});

/* PROFILE UPLOAD */
profileInput.onchange=async()=>{
 const fd=new FormData();
 fd.append("file",profileInput.files[0]);
 fd.append("upload_preset",PRESET_PROFILE);

 const r=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD}/image/upload`,
 {method:"POST",body:fd});
 const d=await r.json();

 await setDoc(doc(db,"users",auth.currentUser.uid),
 {profileImage:d.secure_url},{merge:true});

 profileImg.src=d.secure_url;
};

/* REEL UPLOAD (FIXED) */
reelInput.onchange=async()=>{
 const fd=new FormData();
 fd.append("file",reelInput.files[0]);
 fd.append("upload_preset",PRESET_REEL);

 const r=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD}/video/upload`,
 {method:"POST",body:fd});
 const d=await r.json();

 await addDoc(collection(db,"reels"),{
  uid:auth.currentUser.uid,
  reelUrl:d.secure_url,
  createdAt:new Date()
 });

 const ref=doc(db,"users",auth.currentUser.uid);
 if((await getDoc(ref)).exists()){
  await updateDoc(ref,{reelCount:increment(1)});
 }else{
  await setDoc(ref,{reelCount:1},{merge:true});
 }

 loadProfile(auth.currentUser.uid);
 loadReels(auth.currentUser.uid);
};

window.logout=()=>{signOut(auth);location.reload()};
</script>
</body>
</html>
